<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">

		<meta name="viewport" content="width=device-width, initial-scale=1">

		<title>testing media stream recorder</title>

		<style type="text/css">
			body {
				font-family: sans-serif;
				font-size: 1.3em;
			}

			.not-authorized .gui,
			.authorized .notice {
				display: none;
			}
		</style>
	</head>

	<body class="not-authorized">
		<h1>testing media stream recorder</h1>

		<!-- <script src="MediaStreamRecorder.js"></script> -->

		<script>
			var DT = 3000; 
		</script>

		<div class="notice">please accept webcam permissions above</div>

		<div class="gui">
			<button id="b1" onclick="log('starting'); mediaRecorder.start(DT);">start</button>
			<button id="b2" onclick="log('stopping'); stopped = true; mediaRecorder.stop();">stop</button>
		</div>

		<script>


			var mediaConstraints = {
			    //audio: !!navigator.mozGetUserMedia, // ffox-only
			    audio: false,
			    video: true // chrome too
			};
			console.log("Getting user media!")
			navigator.mediaDevices.getUserMedia(mediaConstraints)
					.then(onMediaSuccess)
					.catch(onMediaError);

			function log(msg) {
				var el = document.createElement('div');
				el.appendChild( document.createTextNode(msg) );
				document.body.appendChild(el);
			}

			// https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/Sending_and_Receiving_Binary_Data
			function send(url, blob) {
				var xhr = new XMLHttpRequest();
				xhr.open('POST', url, true);

				xhr.setRequestHeader('Content-Type', 'video/webm');
				//xhr.setRequestHeader("Content-Length", blob.length);
				
				xhr.onload = function(e) {
					if (this.status === 200) {
						console.log(this.response);
					}
				};
				
				xhr.responseType = 'text/plain';
				xhr.send(blob);
			}

			var maxI = Math.pow(32, 6); // length 6
			
			function randomString() {
				return ( ~~( Math.random() * maxI ) ).toString(32);
			}

			var mediaRecorder;
			var stopped = false;
			var count = 0;
			var name = randomString();

			function onMediaSuccess(stream) {
				console.log("Media success!")
				log('will start capturing and sending ' + (DT/1000) + 's videos when you press start');
				document.body.className = 'authorized';

			    mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });
			    
			    mediaRecorder.ondataavailable = blobEvent => { 
					const blob = blobEvent.data;
			    	var formattedCount = count.toString().padStart(5, '0');
			    	log('sending chunk ' + name + ' #' + formattedCount + '...');
					
			    	send('/chunk/' + name + '/' + formattedCount + (stopped ? '/finish' : ''), blob);
			    	++count;
			    };
			}

			function onMediaError(e) {
				console.log(e)
			    log('media error');
			}
		</script>
	</body>
</html>